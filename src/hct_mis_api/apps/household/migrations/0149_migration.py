# Generated by Django 3.2.18 on 2023-06-16 10:56

from django.db import migrations, models

from django.db.models import Count

from hct_mis_api.apps.household.models import ROLE_ALTERNATE


def update_individuals_with_multiple_roles(apps, schema_editor) -> None:
    IndividualRoleInHousehold = apps.get_model('household', 'IndividualRoleInHousehold')
    multiple_roles_within_household_individual = (
        IndividualRoleInHousehold.objects.values("household", "individual")
        .annotate(Count("id"))
        .order_by()
        .filter(id__count__gt=1)
    )
    for household_individual_pair in multiple_roles_within_household_individual:
        IndividualRoleInHousehold.objects.filter(
            household=household_individual_pair["household"],
            individual=household_individual_pair["individual"],
            role=ROLE_ALTERNATE,
        ).delete()


class Migration(migrations.Migration):

    dependencies = [
        ('household', '0148_migration'),
    ]

    operations = [
        migrations.RunPython(update_individuals_with_multiple_roles, migrations.RunPython.noop),
        migrations.AlterUniqueTogether(
            name='individualroleinhousehold',
            unique_together={('household', 'individual'), ('role', 'household')},
        ),
    ]
