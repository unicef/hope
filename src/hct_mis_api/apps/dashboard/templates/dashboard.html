<!DOCTYPE html>
<html lang="en">
    <head>
        <meta description="hope,hct,dashboard">
        <meta charset="UTF-8">
        <meta keywords="hope,dashboard,unicef">
        <title>Payment Dashboard</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/4.2.6/dc.min.js"></script>
        <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
        <link rel="stylesheet"
              href="https://cdnjs.cloudflare.com/ajax/libs/dc/4.2.6/dc.min.css" />
        <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
              rel="stylesheet">
              <style>
                .dc-chart .deselected {
                    opacity: 0.3;
                }
                #month-chart {
                    width: 100%;
                    height: 400px;
                }
                .max-w-7xl {
                    width: 100%;
                    margin: 0 auto;
                }
                .sidebar {
                    width: 250px;
                    background-color: #ff6f00; /* vibrant orange */
                    color: white;
                    height: 100vh;
                    padding-top: 20px;
                    position: fixed;
                    top: 0;
                    left: 0;
                    transition: width 0.3s ease-in-out;
                }
                .sidebar.collapsed {
                    width: 80px; /* collapsed width */
                }
                .sidebar a {
                    padding: 10px;
                    text-decoration: none;
                    color: white;
                    display: block;
                    margin: 10px 0;
                    transition: padding-left 0.3s ease-in-out;
                }
                .sidebar a:hover {
                    background-color: #ff9800; /* light orange background */
                }
                .header-bar {
                    width: calc(100% - 250px);
                    background-color: #374151; /* dark background */
                    color: white;
                    position: fixed;
                    top: 0;
                    right: 0;
                    height: 60px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 0 20px;
                    transition: width 0.3s ease-in-out;
                }
                .main-content {
                    margin-left: 250px;
                    margin-top: 80px;
                    padding: 20px;
                    transition: margin-left 0.3s ease-in-out;
                }
                .sidebar.collapsed ~ .header-bar {
                    width: calc(100% - 80px);
                }
                .sidebar.collapsed ~ .main-content {
                    margin-left: 80px;
                }
                .toggle-btn {
                    position: absolute;
                    top: 20px;
                    left: 240px;
                    background-color: #ff6f00;
                    color: white;
                    cursor: pointer;
                    padding: 8px;
                    transition: left 0.3s ease-in-out;
                }
                .collapsed .toggle-btn {
                    left: 60px;
                }
            </style>
    </head>
    <body class="bg-gray-100">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <button class="toggle-btn" id="toggle-btn">â˜°</button>
            <h3 class="text-xl font-semibold text-center">Dashboard Menu</h3>
            <a href="#">Overview</a>
            <a href="#">Programs</a>
            <a href="#">Payments</a>
            <a href="#">Reports</a>
            <a href="#">Settings</a>
        </div>
        <!-- Header Bar -->
        <div class="header-bar" id="header-bar">
            <div class="text-lg font-semibold">Business Area Dashboard</div>
            <div>
                <span>Welcome, {{ request.user.username }}</span>
                <a href="{% url 'logout' %}" class="ml-4 bg-blue-600 px-4 py-2 rounded">Logout</a>
            </div>
        </div>
        <div class="main-content max-w-7xl mx-auto p-4 space-y-8">
            <!-- Top Metrics -->
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Total Amount Paid</h3>
                    <div id="total-amount-paid" class="text-xl font-bold"></div>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Number of Payments</h3>
                    <div id="number-of-payments" class="text-xl font-bold"></div>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Outstanding Payment Amounts</h3>
                    <div id="total-local-currency" class="text-xl font-bold"></div>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Households Reached</h3>
                    <div id="households-reached" class="text-xl font-bold"></div>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">PWD Reached</h3>
                    <div id="pwd-reached" class="text-xl font-bold"></div>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Children Reached</h3>
                    <div id="children-reached" class="text-xl font-bold"></div>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Individuals Reached</h3>
                    <div id="individuals-reached" class="text-xl font-bold"></div>
                </div>
            </div>
            <!-- Middle Section (Charts) -->
            <div class="grid grid-cols-3 gap-4">
                <!-- Payments by FSP -->
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Payments by FSP</h3>
                    <div id="payments-by-fsp" class="dc-chart"></div>
                </div>
                <!-- Payments by Delivery Mechanism -->
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Payments by Delivery Mechanism</h3>
                    <div id="payments-by-delivery" class="dc-chart"></div>
                </div>
                <!-- Payments by Sector -->
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Payments by Sector</h3>
                    <div id="payments-by-sector" class="dc-chart"></div>
                </div>
                <!-- Volume by Programme Structure -->
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold">Volume by Programme Structure</h3>
                    <div id="volume-by-program" class="dc-chart"></div>
                </div>
            </div>
            <!-- Bottom Section (Verification) -->
            <div class="grid grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded shadow text-center">
                    <h3 class="text-lg font-semibold">Reconciliation</h3>
                    <div class="text-green-500 text-xl font-bold reconciliation-percentage">%</div>
                    <p>Payment records are reconciled</p>
                </div>
                <div class="bg-white p-4 rounded shadow text-center">
                    <h3 class="text-lg font-semibold">Pending Reconciliation</h3>
                    <div class="text-red-500 text-xl font-bold pending-reconciliation-percentage">%</div>
                    <p>Payments pending</p>
                </div>
                <div class="bg-white p-4 rounded shadow text-center">
                    <h3 class="text-lg font-semibold">Verified</h3>
                    <div class="text-green-500 text-xl font-bold">62%</div>
                    <p>Payments verified</p>
                </div>
                <div class="bg-white p-4 rounded shadow text-center">
                    <h3 class="text-lg font-semibold">Sampling Sites Verified</h3>
                    <div class="text-green-500 text-xl font-bold">72%</div>
                    <p>Verification of sampling sites</p>
                </div>
            </div>
        </div>
        <script>
        function fetchDataForCountry(country) {

        dc.config.defaultColors(d3.schemeTableau10);
        const numberFormatter = d3.format(",.2f");

        function showSpinner(chartId) {
            document.getElementById(chartId).innerHTML = `<div class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full text-blue-500 border-t-transparent"></div>`;
        }

        function hideSpinner(chartId) {
            document.getElementById(chartId).innerHTML = '';
        }
       
        const url = "{% url 'api:household-data' business_area_slug %}";

        function updateTotals(ndx, successfulPaymentsCount, totalPaymentsCount, pendingPaymentsCount) {
            const totalLocal = ndx.groupAll().reduceSum(d => d.delivered_quantity).value();
            const totalUSD = ndx.groupAll().reduceSum(d => d.delivered_quantity_usd).value();
            const householdsReached = ndx.dimension(d => d.id).group().all().length;
            const individualsReached = ndx.groupAll().reduceSum(d => d.size).value();
            const reconciliationPercentage = (successfulPaymentsCount / totalPaymentsCount) * 100;
            const pendingReconciliationPercentage = (pendingPaymentsCount / totalPaymentsCount) * 100;


            // Update the UI
            document.getElementById("total-amount-paid").innerHTML = `${totalUSD.toFixed(2)} USD`;
            document.getElementById("households-reached").innerHTML = `${householdsReached}`; 
            document.getElementById("individuals-reached").innerHTML = `${individualsReached}`; 
            document.getElementById("pwd-reached").innerHTML = `${householdsReached}`;
            document.getElementById("total-local-currency").innerHTML = `${totalLocal.toFixed(2)} AFN`;
            document.querySelector(".reconciliation-percentage").innerHTML = `${reconciliationPercentage.toFixed(2)}%`;
            document.querySelector(".pending-reconciliation-percentage").innerHTML = `${pendingReconciliationPercentage.toFixed(2)}%`;
        }

        function createDashboard() {
            // Set up charts
            const fspChart = dc.pieChart('#payments-by-fsp');
            const deliveryChart = dc.pieChart('#payments-by-delivery');
            const sectorChart = dc.rowChart('#payments-by-sector');
            const volumeChart = dc.rowChart('#volume-by-program');
            
        
            showSpinner('payments-by-fsp');
            showSpinner('payments-by-delivery');
            showSpinner('payments-by-sector');
            showSpinner('volume-by-program');
        
            d3.json(url).then(function(data) {
                let processedPayments = [];
        
                data.forEach(household => {
                    household.payments.forEach(payment => {
                        processedPayments.push({
                            business_area: household.business_area,
                            delivered_quantity: payment.delivered_quantity ? parseFloat(payment.delivered_quantity) : 0,
                            delivered_quantity_usd: payment.delivered_quantity_usd ? parseFloat(payment.delivered_quantity_usd) : 0,
                            payment_status: payment.status,
                            delivery_date: new Date(payment.delivery_date),
                            year: new Date(payment.delivery_date).getFullYear(),
                            month: new Date(payment.delivery_date).getMonth(),
                            program: household.program,
                            admin1: household.admin1,
                            admin2: household.admin2,
                            sector: household.sector,
                            fsp: payment.fsp,
                            delivery_type: payment.delivery_type,
                            size: household.size,
                            children_count: household.children_count ? household.children_count : 0,
                            id: household.id 
                        });
                    });
                });
        
                processedPayments.sort(function(a, b) {
                    return a.delivery_date - b.delivery_date; 
                });

                const ndx = crossfilter(processedPayments); 
                const all = ndx.groupAll();

                function updateTopMetrics() {
                    const totalPaymentsCount = ndx.groupAll().reduceCount().value();
                    const successfulPaymentsGroup = ndx.groupAll().reduce(
                        (p, v) => {
                            if (["Transaction Successful", "Distribution Successful", "Partially Distributed"].includes(v.payment_status)) {
                                p.count += 1;
                                p.sum += v.delivered_quantity_usd ? parseFloat(v.delivered_quantity_usd) : 0;
                            }
                            return p;
                        },
                        (p, v) => {
                            if (["Transaction Successful", "Distribution Successful", "Partially Distributed"].includes(v.payment_status)) {
                                p.count -= 1;
                                p.sum -= v.delivered_quantity_usd ? parseFloat(v.delivered_quantity_usd) : 0;
                            }
                            return p;
                        },
                        () => ({count: 0, sum: 0})
                    ).value();
                    
                    const totalSuccessfulUSD = successfulPaymentsGroup.sum;
                    const successfulPaymentsCount = successfulPaymentsGroup.count;
                    const pendingPaymentsGroup = ndx.groupAll().reduce(
                        (p, v) => {
                            if (v.payment_status === "Pending") {
                                p.count += 1;
                                p.sum += v.delivered_quantity_usd ? parseFloat(v.delivered_quantity_usd) : 0;
                            }
                            return p;
                        },
                        (p, v) => {
                            if (v.payment_status === "Pending") {
                                p.count -= 1;
                                p.sum -= v.delivered_quantity_usd ? parseFloat(v.delivered_quantity_usd) : 0;
                            }
                            return p;
                        },
                        () => ({count: 0, sum: 0})
                    ).value();
        
                    const totalPendingUSD = pendingPaymentsGroup.sum;
                    const pendingPaymentsCount = pendingPaymentsGroup.count;
                    const householdsReached = ndx.dimension(d => d.id).group().all().length;
                    const individualsReached = ndx.groupAll().reduceSum(d => d.size).value();
                    const childrenReached = ndx.groupAll().reduce(
                        (p, v) => {
                            p += v.children_count ? v.children_count : 0;
                            return p;
                        },
                        (p, v) => {
                            p -= v.children_count ? v.children_count : 0;
                            return p;
                        },
                        () => 0
                    ).value();
        
                    document.getElementById("number-of-payments").innerHTML = `${numberFormatter(successfulPaymentsCount)}`;
                    document.getElementById("total-amount-paid").innerHTML = `${numberFormatter(totalSuccessfulUSD)} USD`;
                    document.getElementById("total-local-currency").innerHTML = `${numberFormatter(totalPendingUSD)} USD`;
                    document.getElementById("households-reached").innerHTML = `${householdsReached}`;
                    document.getElementById("individuals-reached").innerHTML = `${individualsReached}`;
                    document.getElementById("children-reached").innerHTML = `${childrenReached}`; 
                    const reconciliationPercentage = (successfulPaymentsCount / totalPaymentsCount) * 100;
                    const pendingReconciliationPercentage = (pendingPaymentsCount / totalPaymentsCount) * 100;
        
                    document.querySelector(".reconciliation-percentage").innerHTML = `${reconciliationPercentage.toFixed(2)}%`;
                    document.querySelector(".pending-reconciliation-percentage").innerHTML = `${pendingReconciliationPercentage.toFixed(2)}%`;
                }
                const dateExtent = d3.extent(processedPayments, function(d) {
                    return d.delivery_date;
                });
                        
                const fspDim = ndx.dimension(d => d.fsp);
                const fspGroup = fspDim.group().reduceSum(d => d.delivered_quantity);
                fspChart
                    .dimension(fspDim)
                    .group(fspGroup)
                    .radius(100)
                    .innerRadius(30)
                    .renderLabel(true)
                    .useViewBoxResizing(true)
                    .label(function (d) {
                        const percentage = (d.value / fspGroup.all().reduce((sum, g) => sum + g.value, 0)) * 100;
                        return `${d.key}:  ${percentage.toFixed(0)}%`; 
                    })
                    .title(function (d) {
                        return `${d.key}: ${numberFormatter(d.value)}`;
                    });
        
                const deliveryDim = ndx.dimension(d => d.delivery_type);
                const deliveryGroup = deliveryDim.group().reduceSum(d => d.delivered_quantity);
                deliveryChart
                    .dimension(deliveryDim)
                    .group(deliveryGroup)
                    .radius(100)
                    .innerRadius(30)
                    .renderLabel(true)
                    .useViewBoxResizing(true)
                    .label(function (d) {
                        const percentage = (d.value / deliveryGroup.all().reduce((sum, g) => sum + g.value, 0)) * 100;
                        return `${d.key} ${percentage.toFixed(0)}%`;
                    })
                    .title(function (d) {
                        return `${d.key}: ${numberFormatter(d.value)}`;  
                    });
        
                const sectorDim = ndx.dimension(d => d.sector);
                const sectorGroup = sectorDim.group().reduceSum(d => d.delivered_quantity);
                sectorChart
                    .dimension(sectorDim)
                    .group(sectorGroup)
                    .elasticX(true)
                    .height(300)
                    .label(function(d) {
                        const total = sectorGroup.all().reduce((sum, g) => sum + g.value, 0);
                        const percentage = (d.value / total) * 100;
                        return `${d.key}: ${numberFormatter(d.value)} (${percentage.toFixed(0)}%)`; 
                    })
                    .title(function(d) {
                        return `${d.key}: ${numberFormatter(d.value)}`;
                    })
                    .xAxis().ticks(4); 
        
                const volumeDim = ndx.dimension(d => d.program);
                const volumeGroup = volumeDim.group().reduceSum(d => d.delivered_quantity);
                volumeChart
                    .dimension(volumeDim)
                    .group(volumeGroup)
                    .elasticX(true)  
                    .height(300)
                    .label(function(d) {
                        const total = volumeGroup.all().reduce((sum, g) => sum + g.value, 0);
                        const percentage = (d.value / total) * 100;
                        return `${d.key}: ${numberFormatter(d.value)} (${percentage.toFixed(0)}%)`;
                    })
                    .title(function(d) {
                        return `${d.key}: ${numberFormatter(d.value)}`; 
                    })
                    .xAxis().ticks(4); 
                       
                hideSpinner('payments-by-fsp');
                hideSpinner('payments-by-delivery');
                hideSpinner('payments-by-sector');
                hideSpinner('volume-by-program');
                    
                const dcCharts = [fspChart, deliveryChart, sectorChart, volumeChart];
                dcCharts.forEach(chart => {
                    chart.on('filtered', () => {
                        updateTopMetrics();
                        dc.redrawAll();
                    });
                });
        
                dc.renderAll();
        
                updateTopMetrics();
            });
        }
        createDashboard();
        }
        fetchDataForCountry("{{ business_area_slug }}");
        </script>
    </body>
</html>
