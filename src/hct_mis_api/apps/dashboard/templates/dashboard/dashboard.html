{% load i18n static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta description="hope,hct,dashboard">
        <meta charset="UTF-8">
        <meta keywords="hope,dashboard,unicef">
        <title>{{ business_area_slug }} {% translate "Dashboard" %}</title>
        <!-- JS Libraries -->
        <script src="{% static 'dashboard/js/d3.min.js' %}"></script>
        <script src="{% static 'dashboard/js/crossfilter.min.js' %}"></script>
        <script src="{% static 'dashboard/js/dc.min.js' %}"></script>
        <script src="{% static 'dashboard/js/d3-scale-chromatic.v1.min.js' %}"></script>
        <!-- CSS Libraries -->
        <link rel="stylesheet" href="{% static 'dashboard/css/dc.min.css' %}" />
        <link rel="stylesheet"
              href="{% static 'dashboard/css/Humanitarian-Icons.css' %}">
        <link rel="stylesheet" href="{% static 'dashboard/css/tailwind.min.css' %}">
        <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
    </head>
    <body class="bg-slate-200">
        <div class="main-content max-w-7xl mx-auto p-4 space-y-8">
            {% if has_permission %}
                <!-- Year Tabs -->
                <div id="year-tabs" class="mb-4">
                    <div class="tab-list flex space-x-2 overflow-x-auto bg-sky-50 rounded shadow p-2"></div>
                </div>
                <!-- Flex container for left and right sections -->
                <div class="flex space-x-4">
                    <!-- Left block for metrics -->
                    <div class="basis-5/6 grid grid-cols-4 gap-2">
                        <div class="bg-white p-4 rounded shadow">
                            <h3 class="text-sm font-semibold">
                                <span class="icon icon-financing icon-blue"></span>
                                {% translate "Total Amount Paid" %}
                            </h3>
                            <div id="total-amount-paid" class="text-sm font-bold  text-center"></div>
                        </div>
                        <div class="bg-white p-4 rounded shadow">
                            <h3 class="text-sm font-semibold">
                                <span class="icon icon-financing icon-blue"></span>
                                {% translate "In Local Currency" %}
                            </h3>
                            <div id="total-amount-paid-local" class="text-sm font-bold text-center"></div>
                        </div>
                        <div class="bg-white p-4 rounded shadow">
                            <h3 class="text-sm font-semibold">
                                <span class="icon icon-preparedness icon-blue"></span>
                                {% translate "Number of Payments" %}
                            </h3>
                            <div id="number-of-payments" class="text-sm font-bold text-center"></div>
                        </div>
                        <div class="bg-white p-4 rounded shadow">
                            <h3 class="text-sm font-semibold">
                                <span class="icon icon-financing icon-blue"></span>
                                {% translate "Outstanding Payment" %}
                            </h3>
                            <div id="outstanding-payments" class="text-sm font-bold text-center"></div>
                        </div>
                        <div class="bg-white p-4 rounded shadow">
                            <h3 class="text-sm font-semibold">
                                <span class="icon icon-house icon-blue"></span>
                                {% translate "Households Reached" %}
                            </h3>
                            <div id="households-reached" class="text-sm font-bold text-center"></div>
                        </div>
                        <div class="bg-white p-4 rounded shadow">
                            <h3 class="text-sm font-semibold">
                                <span class="icon icon-people-targeted icon-blue"></span>
                                {% translate "Individuals Reached" %}
                            </h3>
                            <div id="individuals-reached" class="text-sm font-bold text-center"></div>
                        </div>
                        <div class="bg-white p-4 rounded shadow">
                            <h3 class="text-sm font-semibold">
                                <span class="icon icon-children icon-blue"></span>
                                {% translate "Children Reached" %}
                            </h3>
                            <div id="children-reached" class="text-sm font-bold text-center"></div>
                        </div>
                        <div class="bg-white p-4 rounded shadow">
                            <h3 class="text-sm font-semibold">
                                <span class="icon icon-users icon-blue"></span>
                                {% translate "PWD Reached" %}
                            </h3>
                            <div id="pwd-reached" class="text-sm font-bold text-center"></div>
                        </div>
                    </div>
                    <!-- Right block for Payments by Month chart -->
                    <div class="flex-grow bg-white p-4 rounded shadow h-full">
                        <h3 class="text-sm font-semibold">
                            <span class="icon icon-calendar icon-blue"></span>
                            {% translate "Months" %}
                        </h3>
                        <div id="payments-by-month" class="dc-cahrt w-full h-full"></div>
                    </div>
                </div>
                <!-- Other charts Section -->
                <div class="flex flex-grow grid grid-cols-3 gap-2 mt-8">
                    <div class="bg-white p-3 rounded shadow">
                        <h3 class="text-sm font-semibold">
                            <span class="icon icon-analysis icon-blue"></span>
                            {% translate "Payments by Sector" %}
                        </h3>
                        <div id="payments-by-sector" class="dc-cahrt w-full h-full"></div>
                    </div>
                    <div class="bg-white p-3 rounded shadow">
                        <h3 class="text-sm font-semibold">
                            <span class="icon icon-people-targeted icon-blue"></span>
                            {% translate "Payments by Programme" %}
                        </h3>
                        <div id="volume-by-program" class="dc-cahrt w-full h-full"></div>
                    </div>
                    <div class="bg-white p-3 rounded shadow">
                        <h3 class="text-sm font-semibold">
                            <span class="icon icon-cash-transfer icon-blue"></span>
                            {% translate "Payments by Admin 1" %}
                        </h3>
                        <div id="payments-by-admin1" class="dc-cahrt w-full h-full"></div>
                    </div>
                    <div class="bg-white p-3 rounded shadow">
                        <h3 class="text-sm font-semibold">
                            <span class="icon icon-logistics icon-blue"></span>
                            {% translate "Payments by FSP" %}
                        </h3>
                        <div id="payments-by-fsp" class="dc-cahrt w-full h-full"></div>
                    </div>
                    <div class="bg-white p-4 rounded shadow">
                        <h3 class="text-sm font-semibold">
                            <span class="icon icon-financing icon-blue"></span>
                            {% translate "Payments by Delivery Mechanism" %}
                        </h3>
                        <div id="payments-by-delivery" class="dc-cahrt w-full h-full"></div>
                    </div>
                    <div class="flex flex-col gap-4 mt-4 ml-2">
                        <div class="bg-white p-4 rounded shadow text-center">
                            <h3 class="text-lg font-semibold">
                                <span class="icon icon-report icon-blue"></span>
                                {% translate "Reconciliation" %}
                            </h3>
                            <div class="text-green-500 text-base font-bold reconciliation-percentage">%</div>
                            <p>{% translate "Payment records are reconciled" %}</p>
                        </div>
                        <div class="bg-white p-4 rounded shadow text-center">
                            <h3 class="text-lg font-semibold">
                                <span class="icon icon-report icon-blue"></span>
                                {% translate "Pending Reconciliation" %}
                            </h3>
                            <div class="text-red-500 text-base font-bold pending-reconciliation-percentage">%</div>
                            <p>{% translate "Payments pending" %}</p>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="error-message">{{ error_message }}</div>
            {% endif %}
        </div>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const currentYear = new Date().getFullYear();
                let isChartsInitialized = false;

                function fetchDataForCountry() {
                    dc.config.defaultColors(d3.schemeTableau10);
                    const decimalnumberFormatter = d3.format(",.2f");
                    const simplenumberFormatter = d3.format(",");
                    const truncateLabel = (label, maxLength = 30) => {
                        return label.length > maxLength ?
                            `${label.slice(0, maxLength)}...` :
                            label;
                    };

                    function showSpinner(chartId) {
                        document.getElementById(chartId).innerHTML =
                            `<div class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full text-blue-500 border-t-transparent"></div>`;
                    }

                    function hideSpinner(chartId) {
                        document.getElementById(chartId).innerHTML = "";
                    }

                    const url = "{{household_data_url}}";
                    const pendingList = ["Sent to Payment Gateway", "Pending"];
                    const successfulList = [
                        "Distribution Successful",
                        "Partially Distributed",
                        "Sent to FSP",
                        "Transaction Successful",
                    ];

                    function createDashboard() {
                        [
                            "payments-by-fsp",
                            "payments-by-delivery",
                            "payments-by-sector",
                            "volume-by-program",
                            "payments-by-admin1",
                            "payments-by-month",
                        ].forEach(showSpinner);

                        d3.json(url).then((data) => {
                            if (!data || data.length === 0) {
                                console.error("No data available or data is undefined.");
                                return;
                            }

                            const processedPayments = data.map((item) => ({
                                currency: item.currency || "USD",
                                delivered_quantity_usd: Number.parseFloat(item.total_delivered_quantity_usd) || 0.0,
                                delivered_quantity: Number.parseFloat(item.total_delivered_quantity) || 0.0,
                                payments: item.payments || 0,
                                individuals: item.individuals || 0,
                                households: item.households || 0,
                                children_counts: item.children_counts || 0,
                                month: item.month || "Unknown month",
                                year: item.year || "Unknown year",
                                program: item.program || "Unknown program",
                                sector: item.sector || "Unknown sector",
                                payment_status: item.status || "Unknown status",
                                admin1: item.admin1 || "Unknown admin1",
                                fsp: item.fsp || "Unknown fsp",
                                delivery_types: item.delivery_types || "Unknown delivery type",
                                pwd_counts: item.pwd_counts || 0,
                            }));

                            const ndx = crossfilter(processedPayments);

                            // Define dimensions and groups
                            const yearDim = ndx.dimension((d) => d.year);
                            const fspDim = ndx.dimension((d) => d.fsp);
                            const deliveryDim = ndx.dimension((d) => d.delivery_types);
                            const sectorDim = ndx.dimension((d) => d.sector);
                            const programDim = ndx.dimension((d) => d.program);
                            const idDim = ndx.dimension((d) => d.id);
                            const monthDim = ndx.dimension((d) => d.month);
                            const admin1Dim = ndx.dimension((d) => d.admin1);

                            const fspGroup = fspDim
                                .group()
                                .reduceSum((d) => d.delivered_quantity_usd);
                            const deliveryGroup = deliveryDim
                                .group()
                                .reduceSum((d) => d.delivered_quantity_usd);
                            const sectorGroup = sectorDim
                                .group()
                                .reduceSum((d) => d.delivered_quantity_usd);
                            const programGroup = programDim
                                .group()
                                .reduceSum((d) => d.delivered_quantity_usd);
                            const admin1Group = admin1Dim
                                .group()
                                .reduceSum((d) => d.delivered_quantity_usd)
                                .order((d) => -d);
                            const topAdmin1Group = {
                                all: () => admin1Group.all().slice(0, 30), // Top 30 admin1
                            };
                            const monthGroup = monthDim
                                .group()
                                .reduceSum((d) => d.delivered_quantity_usd);
                            const localCurrency =
                                processedPayments.find((item) => item.currency)?.currency || "USD";

                            // Define charts
                            const fspChart = dc
                                .pieChart("#payments-by-fsp")
                                .dimension(fspDim)
                                .group(fspGroup)
                                .radius(100)
                                .innerRadius(40)
                                .renderLabel(true)
                                .useViewBoxResizing(true)
                                .label(
                                    (d) =>
                                    `${truncateLabel(d.key)}: ${((d.value / fspGroup.all().reduce((sum, g) => sum + g.value, 0)) * 100).toFixed(0)}%`,
                                )
                                .title((d) => `${d.key}: ${decimalnumberFormatter(d.value)}`);

                            const deliveryChart = dc
                                .pieChart("#payments-by-delivery")
                                .dimension(deliveryDim)
                                .group(deliveryGroup)
                                .radius(100)
                                .innerRadius(30)
                                .renderLabel(true)
                                .useViewBoxResizing(true)
                                .label(
                                    (d) =>
                                    `${d.key} ${((d.value / deliveryGroup.all().reduce((sum, g) => sum + g.value, 0)) * 100).toFixed(0)}%`,
                                )
                                .title((d) => `${d.key}: ${decimalnumberFormatter(d.value)}`);

                            const sectorChart = dc
                                .rowChart("#payments-by-sector")
                                .dimension(sectorDim)
                                .group(sectorGroup)
                                .elasticX(true)
                                .height(300)
                                .label(
                                    (d) =>
                                    `${d.key}: ${decimalnumberFormatter(d.value)} USD (${((d.value / sectorGroup.all().reduce((sum, g) => sum + g.value, 0)) * 100).toFixed(0)}%)`,
                                )
                                .title((d) => `${d.key}: ${decimalnumberFormatter(d.value)} USD`)
                                .xAxis()
                                .ticks(4);

                            const programChart = dc
                                .rowChart("#volume-by-program")
                                .dimension(programDim)
                                .group(programGroup)
                                .elasticX(true)
                                .height(400)
                                .label(
                                    (d) =>
                                    `${truncateLabel(d.key)}: ${decimalnumberFormatter(d.value)} USD (${((d.value / programGroup.all().reduce((sum, g) => sum + g.value, 0)) * 100).toFixed(0)}%)`,
                                )
                                .title((d) => `${d.key}: ${decimalnumberFormatter(d.value)} USD`)
                                .xAxis()
                                .ticks(5);

                            const monthOrder = {
                                January: 1,
                                February: 2,
                                March: 3,
                                April: 4,
                                May: 5,
                                June: 6,
                                July: 7,
                                August: 8,
                                September: 9,
                                October: 10,
                                November: 11,
                                December: 12,
                            };

                            const monthChart = dc
                                .rowChart("#payments-by-month")
                                .dimension(monthDim)
                                .group(monthGroup)
                                .elasticX(true)
                                .height(400)
                                .useViewBoxResizing(true)
                                .label(
                                    (d) =>
                                    `${d.key} ${((d.value / monthGroup.all().reduce((sum, g) => sum + g.value, 0)) * 100).toFixed(0)}%`,
                                )
                                .title((d) => `${d.key}: ${decimalnumberFormatter(d.value)} USD`)
                                .ordering((d) => monthOrder[d.key])
                                .xAxis()
                                .ticks(5);

                            const admin1Chart = dc
                                .rowChart("#payments-by-admin1")
                                .dimension(admin1Dim)
                                .group(topAdmin1Group)
                                .elasticX(true)
                                .height(400)
                                .label(
                                    (d) =>
                                    `${truncateLabel(d.key)}: ${decimalnumberFormatter(d.value)} USD (${((d.value / admin1Group.all().reduce((sum, g) => sum + g.value, 0)) * 100).toFixed(0)}%)`,
                                )
                                .title((d) => `${d.key}: ${decimalnumberFormatter(d.value)} USD`)
                                .xAxis()
                                .ticks(5);

                            function updateTopMetrics() {
                                const totalPaymentsCount = ndx.groupAll().reduceCount().value();
                                const successfulPaymentsGroupUSD = ndx
                                    .groupAll()
                                    .reduce(
                                        (p, v) => {
                                            if (successfulList.includes(v.payment_status)) {
                                                p.count += 1;
                                                p.sum += v.delivered_quantity_usd || 0;
                                            }
                                            return p;
                                        },
                                        (p, v) => {
                                            if (successfulList.includes(v.payment_status)) {
                                                p.count -= 1;
                                                p.sum -= v.delivered_quantity_usd || 0;
                                            }
                                            return p;
                                        },
                                        () => ({
                                            count: 0,
                                            sum: 0,
                                        }),
                                    )
                                    .value();
                                const successfulPaymentsGroup = ndx
                                    .groupAll()
                                    .reduce(
                                        (p, v) => {
                                            if (successfulList.includes(v.payment_status)) {
                                                p.count += 1;
                                                p.sum += v.delivered_quantity || 0;
                                            }
                                            return p;
                                        },
                                        (p, v) => {
                                            if (successfulList.includes(v.payment_status)) {
                                                p.count -= 1;
                                                p.sum -= v.delivered_quantity || 0;
                                            }
                                            return p;
                                        },
                                        () => ({
                                            count: 0,
                                            sum: 0,
                                        }),
                                    )
                                    .value();

                                const totalSuccessfulUSD = successfulPaymentsGroupUSD.sum;
                                const totalSuccessful = successfulPaymentsGroup.sum;
                                const successfulPaymentsCountUSD = successfulPaymentsGroupUSD.count;
                                const pendingPaymentsGroupUSD = ndx
                                    .groupAll()
                                    .reduce(
                                        (p, v) => {
                                            if (pendingList.includes(v.payment_status)) {
                                                p.count += 1;
                                                p.sum += v.delivered_quantity_usd || 0;
                                            }
                                            return p;
                                        },
                                        (p, v) => {
                                            if (pendingList.includes(v.payment_status)) {
                                                p.count -= 1;
                                                p.sum -= v.delivered_quantity_usd || 0;
                                            }
                                            return p;
                                        },
                                        () => ({
                                            count: 0,
                                            sum: 0,
                                        }),
                                    )
                                    .value();
                                const pendingPaymentsGroup = ndx
                                    .groupAll()
                                    .reduce(
                                        (p, v) => {
                                            if (pendingList.includes(v.payment_status)) {
                                                p.count += 1;
                                                p.sum += v.delivered_quantity || 0;
                                            }
                                            return p;
                                        },
                                        (p, v) => {
                                            if (pendingList.includes(v.payment_status)) {
                                                p.count -= 1;
                                                p.sum -= v.delivered_quantity || 0;
                                            }
                                            return p;
                                        },
                                        () => ({
                                            count: 0,
                                            sum: 0,
                                        }),
                                    )
                                    .value();
                                const householdsReached = idDim
                                    .groupAll()
                                    .reduceSum((d) => d.households)
                                    .value();
                                const individualsReached = ndx
                                    .groupAll()
                                    .reduceSum((d) => d.individuals)
                                    .value();
                                const pwdReached = ndx
                                    .groupAll()
                                    .reduceSum((d) => d.pwd_counts)
                                    .value();
                                const childrenReached = ndx
                                    .groupAll()
                                    .reduce(
                                        (p, v) => p + (v.children_counts || 0),
                                        (p, v) => p - (v.children_counts || 0),
                                        () => 0,
                                    )
                                    .value();

                                document.getElementById("number-of-payments").innerHTML =
                                    `${simplenumberFormatter(successfulPaymentsCountUSD)}`;
                                document.getElementById("outstanding-payments").innerHTML =
                                    `${decimalnumberFormatter(pendingPaymentsGroupUSD.sum)} USD`;
                                document.getElementById("total-amount-paid").innerHTML =
                                    `${decimalnumberFormatter(totalSuccessfulUSD)} USD`;
                                document.getElementById("total-amount-paid-local").innerHTML =
                                    `${decimalnumberFormatter(totalSuccessful)} ${localCurrency}`;
                                document.getElementById("households-reached").innerHTML =
                                    `${simplenumberFormatter(householdsReached)}`;
                                document.getElementById("individuals-reached").innerHTML =
                                    `${simplenumberFormatter(individualsReached)}`;
                                document.getElementById("pwd-reached").innerHTML =
                                    `${simplenumberFormatter(pwdReached)}`;
                                document.getElementById("children-reached").innerHTML =
                                    `${simplenumberFormatter(childrenReached)}`;
                                document.querySelector(".reconciliation-percentage").innerHTML =
                                    `${decimalnumberFormatter((successfulPaymentsCountUSD / totalPaymentsCount) * 100)}%`;
                                document.querySelector(
                                        ".pending-reconciliation-percentage",
                                    ).innerHTML =
                                    `${decimalnumberFormatter((pendingPaymentsGroupUSD.count / totalPaymentsCount) * 100)}%`;
                            }

                            function filterByYear(year) {
                                yearDim.filter(year);
                                updateTopMetrics();
                                if (isChartsInitialized) dc.redrawAll();
                            }

                            function setActiveTab(year) {
                                for (const tab of document.querySelectorAll(".tab-link")) {
                                    tab.classList.remove("bg-cyan-500", "text-white", "shadow-md");
                                    tab.classList.add("bg-cyan-50", "text-gray-600");
                                }
                                const activeTab = document.getElementById(`tab-${year}`);
                                if (activeTab) {
                                    activeTab.classList.remove("bg-sky-50", "text-gray-600");
                                    activeTab.classList.add(
                                        "bg-cyan-500",
                                        "text-cyan-800",
                                        "font-semibold",
                                        "shadow-md",
                                        "rounded-md",
                                    );
                                }
                            }

                            window.changeYear = (year) => {
                                setActiveTab(year);
                                dc.filterAll();
                                filterByYear(year);
                            };

                            const uniqueYears = Array.from(
                                    new Set(processedPayments.map((d) => d.year)),
                                )
                                .filter((year) => year)
                                .sort((a, b) => b - a);
                            const tabListContainer = document.querySelector("#year-tabs .tab-list");

                            for (const year of uniqueYears) {
                                const yearTab = document.createElement("button");
                                yearTab.className =
                                    "tab-link py-2 px-4 font-semibold rounded-lg focus:outline-none transition-colors duration-300 text-gray-900 bg-sky-50";
                                yearTab.id = `tab-${year}`;
                                yearTab.textContent = year;
                                yearTab.onclick = () => changeYear(year);
                                tabListContainer.appendChild(yearTab);
                            }
                            if (uniqueYears.includes(currentYear)) changeYear(currentYear);
                            else if (uniqueYears.length > 0) changeYear(uniqueYears[0]);

                            for (const chart of dc.chartRegistry.list()) {
                                chart.on("filtered", () => {
                                    updateTopMetrics();
                                });
                            }
                            hideSpinner("payments-by-fsp");
                            hideSpinner("payments-by-delivery");
                            hideSpinner("payments-by-sector");
                            hideSpinner("volume-by-program");
                            hideSpinner("payments-by-admin1");
                            hideSpinner("payments-by-month");
                            dc.renderAll();
                            isChartsInitialized = true;
                        });
                    }
                    createDashboard();
                }
                fetchDataForCountry();
            });
        </script>
    </body>
</html>
