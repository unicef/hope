{% load i18n static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta description="hope,hct,dashboard">
        <meta charset="UTF-8">
        <meta keywords="hope,dashboard,unicef">
        <title>{{ business_area_slug }} {% translate "Dashboard" %}</title>
        <!-- JS Libraries -->
        <script src="{% static 'dashboard/js/d3.min.js' %}"></script>
        <script src="{% static 'dashboard/js/crossfilter.min.js' %}"></script>
        <script src="{% static 'dashboard/js/dc.min.js' %}"></script>
        <script src="{% static 'dashboard/js/d3-scale-chromatic.v1.min.js' %}"></script>
        <!-- CSS Libraries -->
        <link rel="stylesheet" href="{% static 'dashboard/css/dc.min.css' %}" />
        <link rel="stylesheet"
              href="{% static 'dashboard/css/Humanitarian-Icons.css' %}">
        <link rel="stylesheet" href="{% static 'dashboard/css/tailwind.min.css' %}">
        <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
    </head>
    <body class="bg-slate-200">
        <div class="main-content max-w-7xl mx-auto p-4 space-y-8">
            {% if has_permission %}
                <!-- Year Tabs -->
                <div id="year-tabs" class="mb-4">
                    <div class="tab-list flex space-x-2 overflow-x-auto bg-sky-50 rounded shadow p-2"></div>
                </div>
                <div class="flex space-x-4">
                    <!-- Left block for metrics -->
                    <div class="basis-5/6 grid grid-cols-4 gap-2">
                        <div class="bg-white p-4 rounded shadow">
                            <h3 class="text-sm font-semibold">
                                <span class="icon icon-financing icon-blue"></span>
                                {% translate "Total Amount Paid" %}
                            </h3>
                            <div id="total-amount-paid" class="text-sm font-bold  text-center"></div>
                        </div>
                        <div class="bg-white p-4 rounded shadow">
                            <h3 class="text-sm font-semibold">
                                <span class="icon icon-preparedness icon-blue"></span>
                                {% translate "Number of Payments" %}
                            </h3>
                            <div id="number-of-payments" class="text-sm font-bold text-center"></div>
                        </div>
                        <div class="bg-white p-4 rounded shadow">
                            <h3 class="text-sm font-semibold">
                                <span class="icon icon-financing icon-blue"></span>
                                {% translate "Outstanding Payment" %}
                            </h3>
                            <div id="outstanding-payments" class="text-sm font-bold text-center"></div>
                        </div>
                        <div class="bg-white p-4 rounded shadow">
                            <h3 class="text-sm font-semibold">
                                <span class="icon icon-house icon-blue"></span>
                                <span class="tooltip"
                                      role="tooltip"
                                      title="{% translate 'Aggregated count of households for the selected months' %}">
                                    {% translate "Households Reached" %}
                                </h3>
                                <div id="households-reached" class="text-sm font-bold text-center"></div>
                            </div>
                            <div class="bg-white p-4 rounded shadow">
                                <h3 class="text-sm font-semibold">
                                    <span class="icon icon-people-targeted icon-blue"></span>
                                    <span class="tooltip"
                                          role="tooltip"
                                          title="{% translate 'Aggregated count of individuals for the selected months' %}">
                                        {% translate "Individuals Reached" %}
                                    </h3>
                                    <div id="individuals-reached" class="text-sm font-bold text-center"></div>
                                </div>
                                <div class="bg-white p-4 rounded shadow">
                                    <h3 class="text-sm font-semibold">
                                        <span class="icon icon-children icon-blue"></span>
                                        <span class="tooltip"
                                              role="tooltip"
                                              title="{% translate 'Aggregated count of children for the selected months' %}">
                                            {% translate "Children Reached" %}
                                        </h3>
                                        <div id="children-reached" class="text-sm font-bold text-center"></div>
                                    </div>
                                    <div class="bg-white p-4 rounded shadow">
                                        <h3 class="text-sm font-semibold">
                                            <span class="icon icon-users icon-blue"></span>
                                            <span class="tooltip"
                                                  role="tooltip"
                                                  title="{% translate 'Aggregated count of pwd for the selected months' %}">
                                                {% translate "PWD Reached" %}
                                            </h3>
                                            <div id="pwd-reached" class="text-sm font-bold text-center"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Other charts Section -->
                                <div class="flex flex-grow grid grid-cols-3 gap-2 mt-8">
                                    <!-- Chart 1 -->
                                    <div class="bg-white p-3 rounded shadow">
                                        <h3 class="text-sm font-semibold">
                                            <span class="icon icon-analysis icon-blue"></span>
                                            {% translate "Payments by Sector" %}
                                        </h3>
                                        <div id="payments-by-sector" class="dc-chart w-full h-full"></div>
                                    </div>
                                    <!-- Chart 2 -->
                                    <div class="bg-white p-3 rounded shadow">
                                        <h3 class="text-sm font-semibold">
                                            <span class="icon icon-people-targeted icon-blue"></span>
                                            {% translate "Payments by Programme" %}
                                        </h3>
                                        <div id="volume-by-program" class="dc-chart w-full h-full"></div>
                                    </div>
                                    <!-- Chart 3 -->
                                    <div class="bg-white p-4 rounded shadow">
                                        <h3 class="text-sm font-semibold">
                                            <span class="icon icon-logistics icon-blue"></span>
                                            {% translate "Payments by FSP" %}
                                        </h3>
                                        <div id="payments-by-fsp" class="dc-chart w-full h-full"></div>
                                    </div>
                                    <!-- Chart 3 - Bar Chart for Countries -->
                                    <div class="bg-white p-4 rounded shadow col-span-3">
                                        <h3 class="text-sm font-semibold">
                                            <span class="icon icon-globe icon-blue"></span>
                                            {% translate "Payments by Country" %}
                                        </h3>
                                        <div id="payments-by-country" class="dc-chart w-full h-[400px]"></div>
                                    </div>
                                    <!-- Chart 4 -->
                                    <div class="bg-white p-4 rounded shadow">
                                        <h3 class="text-sm font-semibold">
                                            <span class="icon icon-financing icon-blue"></span>
                                            {% translate "Payments by Delivery Mechanism" %}
                                        </h3>
                                        <div id="payments-by-delivery" class="dc-chart w-full h-full"></div>
                                    </div>
                                    <!-- Reconciliation Cards Section -->
                                    <div class="flex flex-col gap-4 col-span-1">
                                        <div class="bg-white p-4 rounded shadow text-center">
                                            <h3 class="text-lg font-semibold">
                                                <span class="icon icon-report icon-blue"></span>
                                                {% translate "Reconciliation" %}
                                            </h3>
                                            <div class="text-green-500 text-base font-bold reconciliation-percentage">%</div>
                                            <p>{% translate "Payment are reconciled" %}</p>
                                        </div>
                                        <div class="bg-white p-4 rounded shadow text-center">
                                            <h3 class="text-lg font-semibold">
                                                <span class="icon icon-report icon-blue"></span>
                                                {% translate "Finished Payment Plans" %}
                                            </h3>
                                            <div class="text-red-500 text-base font-bold pending-reconciliation-percentage">%</div>
                                            <p>{% translate "Payments plans" %}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="error-message">{{ error_message }}</div>
                {% endif %}
            </div>
            <!-- JS Script -->
            <script>
            document.addEventListener("DOMContentLoaded", () => {
                const currentYear = new Date().getFullYear();
                let isChartsInitialized = false;

                function fetchDataForCountry() {
                    dc.config.defaultColors(d3.schemeTableau10);
                    const decimalnumberFormatter = d3.format(",.2f");
                    const simplenumberFormatter = d3.format(",");
                    const truncateLabel = (label, maxLength = 25) => {
                        return label.length > maxLength ?
                            `${label.slice(0, maxLength)}...` :
                            label;
                    };

                    function showSpinner(chartId) {
                        document.getElementById(chartId).innerHTML =
                            `<div class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full text-blue-500 border-t-transparent"></div>`;
                    }

                    function hideSpinner(chartId) {
                        document.getElementById(chartId).innerHTML = "";
                    }

                    const url = "{{household_data_url}}";
                    const pendingList = ["Sent to Payment Gateway", "Sent to FSP"];
                    const successfulList = [
                        "Distribution Successful",
                        "Partially Distributed",
                        "Pending",
                        "Transaction Successful",
                    ];

                    function createDashboard() {
                        [
                            "payments-by-fsp",
                            "payments-by-delivery",
                            "payments-by-sector",
                            "volume-by-program",
                            "payments-by-country",
                        ].forEach(showSpinner);

                        d3.json(url).then((data) => {
                            if (!data || data.length === 0) {
                                console.error("No data available or data is undefined.");
                                return;
                            }

                            const processedPayments = data.map((item) => ({
                                delivered_quantity_usd: Number.parseFloat(item.total_delivered_quantity_usd) || 0.0,
                                payments: item.payments || 0,
                                individuals: item.individuals || 0,
                                households: item.households || 0,
                                reconciled: item.reconciled || 0,
                                finished_payment_plans: item.finished_payment_plans || 0,
                                total_payment_plans: item.total_payment_plans || 0,
                                children_counts: item.children_counts || 0,
                                year: item.year || "Unknown year",
                                program: item.program || "Unknown program",
                                sector: item.sector || "Unknown sector",
                                payment_status: item.status || "Unknown status",
                                country: item.country || "Unknown Country",
                                fsp: item.fsp || "Unknown fsp",
                                delivery_types: item.delivery_types || "Unknown delivery type",
                                pwd_counts: item.pwd_counts || 0,
                            }));

                            const ndx = crossfilter(processedPayments);

                            // Define dimensions and groups
                            const idDim = ndx.dimension((d) => d.id);
                            const yearDim = ndx.dimension((d) => d.year);
                            const fspDim = ndx.dimension((d) => d.fsp);
                            const deliveryDim = ndx.dimension((d) => d.delivery_types);
                            const sectorDim = ndx.dimension((d) => d.sector);
                            const programDim = ndx.dimension((d) => d.program);
                            const countryDim = ndx.dimension((d) => d.country);


                            const fspGroup = fspDim
                                .group()
                                .reduceSum((d) => d.delivered_quantity_usd);
                            const deliveryGroup = deliveryDim
                                .group()
                                .reduceSum((d) => d.delivered_quantity_usd);
                            const sectorGroup = sectorDim
                                .group()
                                .reduceSum((d) => d.delivered_quantity_usd);
                            const programGroup = programDim
                                .group()
                                .reduceSum((d) => d.delivered_quantity_usd);
                            const countryGroup = countryDim
                                .group()
                                .reduceSum((d) => d.delivered_quantity_usd);
                                const topProgramGroup = {
                                    all: () => programGroup.all().slice(0, 30), // Top 30 programs
                                };

                            // Define charts
                            const fspChart = dc
                                .pieChart("#payments-by-fsp")
                                .dimension(fspDim)
                                .group(fspGroup)
                                .radius(100)
                                .innerRadius(40)
                                .renderLabel(true)
                                .useViewBoxResizing(true)
                                .label(
                                    (d) =>
                                    `${truncateLabel(d.key)}: ${((d.value / fspGroup.all().reduce((sum, g) => sum + g.value, 0)) * 100).toFixed(0)}%`,
                                )
                                .title((d) => `${d.key}: ${decimalnumberFormatter(d.value)}`);

                            const deliveryChart = dc
                                .pieChart("#payments-by-delivery")
                                .dimension(deliveryDim)
                                .group(deliveryGroup)
                                .radius(100)
                                .innerRadius(30)
                                .renderLabel(true)
                                .useViewBoxResizing(true)
                                .label(
                                    (d) =>
                                    `${d.key} ${((d.value / deliveryGroup.all().reduce((sum, g) => sum + g.value, 0)) * 100).toFixed(0)}%`,
                                )
                                .title((d) => `${d.key}: ${decimalnumberFormatter(d.value)}`);

                            const sectorChart = dc
                                .rowChart("#payments-by-sector")
                                .dimension(sectorDim)
                                .group(sectorGroup)
                                .elasticX(true)
                                .height(300)
                                .label(
                                    (d) =>
                                    `${d.key}: ${decimalnumberFormatter(d.value)} USD (${((d.value / sectorGroup.all().reduce((sum, g) => sum + g.value, 0)) * 100).toFixed(0)}%)`,
                                )
                                .title((d) => `${d.key}: ${decimalnumberFormatter(d.value)} USD`)
                                .xAxis()
                                .ticks(3);

                            const programChart = dc
                                .rowChart("#volume-by-program")
                                .dimension(programDim)
                                .group(topProgramGroup)
                                .elasticX(true)
                                .height(400)
                                .label(
                                    (d) =>
                                    `${truncateLabel(d.key)}: ${decimalnumberFormatter(d.value)} USD (${((d.value / programGroup.all().reduce((sum, g) => sum + g.value, 0)) * 100).toFixed(0)}%)`,
                                )
                                .title((d) => `${d.key}: ${decimalnumberFormatter(d.value)} USD`)
                                .labelOffsetX(10)
                                .useViewBoxResizing(true)
                                .xAxis()
                                .ticks(3);

                            const countryChart = dc
                                .rowChart("#payments-by-country")
                                .dimension(countryDim)
                                .group(countryGroup)
                                .elasticX(true) // Allows the chart to resize based on data
                                .height(400) // Adjust the height of the chart
                                .margins({ top: 20, right: 30, bottom: 30, left: 50 }) // Margins for better spacing
                                .useViewBoxResizing(true) // Enables responsive resizing
                                .renderLabel(true)
                                .label((d) =>
                                    `${d.key}: ${d.value.toFixed(2)} USD (${((d.value / countryGroup.all().reduce((sum, g) => sum + g.value, 0)) * 100).toFixed(0)}%)`
                                ) // Label with country name and percentage
                                .title((d) => `${d.key}: ${d.value.toFixed(2)} USD`) // Tooltip with exact value
                                .xAxis()
                                .ticks(5);

                                function updateTopMetrics() {
                                const totalPaymentsCount = ndx.groupAll().reduceSum(d => d.payments || 0).value();
                                // Reconciled Payments Calculation
                                const reconciledPaymentsCount = ndx
                                    .groupAll()
                                    .reduceSum(d => d.reconciled || 0)
                                    .value();
                                // Fetch total payment plans and finished payment plans from the data
                                const totalPaymentPlans = ndx.groupAll().reduceSum(d => d.total_payment_plans || 0).value();
                                const finishedPaymentPlans = ndx.groupAll().reduceSum(d => d.finished_payment_plans || 0).value();
                                const finishedPercentage = totalPaymentPlans > 0
                                ? (finishedPaymentPlans / totalPaymentPlans) * 100
                                : 0;
                                const successfulPaymentsGroupUSD = ndx
                                    .groupAll()
                                    .reduce(
                                        (p, v) => {
                                            if (successfulList.includes(v.payment_status)) {
                                                p.count += 1;
                                                p.sum += v.delivered_quantity_usd || 0;
                                            }
                                            return p;
                                        },
                                        (p, v) => {
                                            if (successfulList.includes(v.payment_status)) {
                                                p.count -= 1;
                                                p.sum -= v.delivered_quantity_usd || 0;
                                            }
                                            return p;
                                        },
                                        () => ({
                                            count: 0,
                                            sum: 0,
                                        }),
                                    )
                                    .value();

                                const totalSuccessfulUSD = successfulPaymentsGroupUSD.sum;
                                const successfulPaymentsCountUSD = successfulPaymentsGroupUSD.count;
                                const pendingPaymentsGroupUSD = ndx
                                    .groupAll()
                                    .reduce(
                                        (p, v) => {
                                            if (pendingList.includes(v.payment_status)) {
                                                p.count += 1;
                                                p.sum += v.delivered_quantity_usd || 0;
                                            }
                                            return p;
                                        },
                                        (p, v) => {
                                            if (pendingList.includes(v.payment_status)) {
                                                p.count -= 1;
                                                p.sum -= v.delivered_quantity_usd || 0;
                                            }
                                            return p;
                                        },
                                        () => ({
                                            count: 0,
                                            sum: 0,
                                        }),
                                    )
                                    .value();
                                const householdsReached = idDim
                                    .groupAll()
                                    .reduceSum((d) => d.households)
                                    .value();
                                const individualsReached = ndx
                                    .groupAll()
                                    .reduceSum((d) => d.individuals)
                                    .value();
                                const pwdReached = ndx
                                    .groupAll()
                                    .reduceSum((d) => d.pwd_counts)
                                    .value();
                                const childrenReached = ndx
                                    .groupAll()
                                    .reduce(
                                        (p, v) => p + (v.children_counts || 0),
                                        (p, v) => p - (v.children_counts || 0),
                                        () => 0,
                                    )
                                    .value();

                                document.getElementById("number-of-payments").innerHTML =
                                    `${simplenumberFormatter(totalPaymentsCount)}`;
                                document.getElementById("outstanding-payments").innerHTML =
                                    `${decimalnumberFormatter(pendingPaymentsGroupUSD.sum)} USD`;
                                document.getElementById("total-amount-paid").innerHTML =
                                    `${decimalnumberFormatter(totalSuccessfulUSD)} USD`;
                                document.getElementById("households-reached").innerHTML =
                                    `${simplenumberFormatter(householdsReached)}`;
                                document.getElementById("individuals-reached").innerHTML =
                                    `${simplenumberFormatter(individualsReached)}`;
                                document.getElementById("pwd-reached").innerHTML =
                                    `${simplenumberFormatter(pwdReached)}`;
                                document.getElementById("children-reached").innerHTML =
                                    `${simplenumberFormatter(childrenReached)}`;
                                document.querySelector(".reconciliation-percentage").innerHTML =
                                    `${decimalnumberFormatter((reconciledPaymentsCount / totalPaymentsCount) * 100)}%`;
                                document.querySelector(
                                        ".pending-reconciliation-percentage",
                                    ).innerHTML =`${decimalnumberFormatter(finishedPercentage)}%`;
                            }

                            function filterByYear(year) {
                                yearDim.filter(year);
                                updateTopMetrics();
                                if (isChartsInitialized) dc.redrawAll();
                            }

                            function setActiveTab(year) {
                                for (const tab of document.querySelectorAll(".tab-link")) {
                                    tab.classList.remove("bg-cyan-500", "text-white", "shadow-md");
                                    tab.classList.add("bg-cyan-50", "text-gray-600");
                                }
                                const activeTab = document.getElementById(`tab-${year}`);
                                if (activeTab) {
                                    activeTab.classList.remove("bg-sky-50", "text-gray-600");
                                    activeTab.classList.add(
                                        "bg-cyan-500",
                                        "text-cyan-800",
                                        "font-semibold",
                                        "shadow-md",
                                        "rounded-md",
                                    );
                                }
                            }

                            window.changeYear = (year) => {
                                setActiveTab(year);
                                dc.filterAll();
                                filterByYear(year);
                            };

                            const uniqueYears = Array.from(
                                    new Set(processedPayments.map((d) => d.year)),
                                )
                                .filter((year) => year)
                                .sort((a, b) => b - a);
                            const tabListContainer = document.querySelector("#year-tabs .tab-list");

                            for (const year of uniqueYears) {
                                const yearTab = document.createElement("button");
                                yearTab.className =
                                    "tab-link py-2 px-4 font-semibold rounded-lg focus:outline-none transition-colors duration-300 text-gray-900 bg-sky-50";
                                yearTab.id = `tab-${year}`;
                                yearTab.textContent = year;
                                yearTab.onclick = () => changeYear(year);
                                tabListContainer.appendChild(yearTab);
                            }
                            if (uniqueYears.includes(currentYear)) changeYear(currentYear);
                            else if (uniqueYears.length > 0) changeYear(uniqueYears[0]);

                            for (const chart of dc.chartRegistry.list()) {
                                chart.on("filtered", () => {
                                    updateTopMetrics();
                                });
                            }
                            hideSpinner("payments-by-fsp");
                            hideSpinner("payments-by-delivery");
                            hideSpinner("payments-by-sector");
                            hideSpinner("volume-by-program");
                            hideSpinner("payments-by-country");
                            dc.renderAll();
                            isChartsInitialized = true;
                        });
                    }
                    createDashboard();
                }
                fetchDataForCountry();
            });
            </script>
        </body>
    </html>
