# Generated by Django 3.2.25 on 2025-06-05 12:04

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion
import model_utils.fields
import uuid


class Migration(migrations.Migration):
    dependencies = [
        ("geo", "0004_migration"),
        ("auth", "0012_alter_user_first_name_max_length"),
        ("program", "0005_migration"),
        ("core", "0007_migration"),
        ("account", "0009_migration"),
    ]

    operations = [
        migrations.CreateModel(
            name="AdminAreaLimitedTo",
            fields=[
                (
                    "id",
                    model_utils.fields.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True, db_index=True)),
                ("areas", models.ManyToManyField(blank=True, related_name="admin_area_limits", to="geo.Area")),
                (
                    "partner",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="admin_area_limits",
                        to="account.partner",
                    ),
                ),
                (
                    "program",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="admin_area_limits",
                        to="program.program",
                    ),
                ),
            ],
        ),
        migrations.CreateModel(
            name="RoleAssignment",
            fields=[
                (
                    "id",
                    model_utils.fields.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True, db_index=True)),
                ("updated_at", models.DateTimeField(auto_now=True, db_index=True)),
                (
                    "expiry_date",
                    models.DateField(
                        blank=True, help_text="After expiry date this Role Assignment will be inactive.", null=True
                    ),
                ),
                (
                    "business_area",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="role_assignments",
                        to="core.businessarea",
                    ),
                ),
                (
                    "group",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="role_assignments",
                        to="auth.group",
                    ),
                ),
                (
                    "partner",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="role_assignments",
                        to="account.partner",
                    ),
                ),
                (
                    "program",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="role_assignments",
                        to="program.program",
                    ),
                ),
            ],
        ),
        migrations.AlterModelOptions(
            name="user",
            options={
                "permissions": (
                    ("can_load_from_ad", "Can load users from ActiveDirectory"),
                    ("can_sync_with_ad", "Can synchronise user with ActiveDirectory"),
                    ("can_create_kobo_user", "Can create users in Kobo"),
                    ("can_import_from_kobo", "Can import and sync users from Kobo"),
                    ("can_upload_to_kobo", "Can upload CSV file to Kobo"),
                    ("can_debug", "Can access debug information"),
                    ("can_inspect", "Can inspect objects"),
                    ("quick_links", "Can see quick links in admin"),
                    ("restrict_help_desk", "Limit fields to be editable for help desk"),
                    ("can_reindex_programs", "Can reindex programs"),
                    ("can_add_business_area_to_partner", "Can add business area to partner"),
                    ("can_change_allowed_partners", "Can change allowed partners"),
                    ("can_change_area_limits", "Can change area limits"),
                    ("can_import_fixture", "Can import fixture"),
                )
            },
        ),
        migrations.AddField(
            model_name="role",
            name="is_available_for_partner",
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name="role",
            name="is_visible_on_ui",
            field=models.BooleanField(default=True),
        ),
        migrations.DeleteModel(
            name="UserRole",
        ),
        migrations.AddField(
            model_name="roleassignment",
            name="role",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="role_assignments",
                to="account.role",
            ),
        ),
        migrations.AddField(
            model_name="roleassignment",
            name="user",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="role_assignments",
                to=settings.AUTH_USER_MODEL,
            ),
        ),
        migrations.AddConstraint(
            model_name="roleassignment",
            constraint=models.CheckConstraint(
                check=models.Q(
                    models.Q(("partner__isnull", True), ("user__isnull", False)),
                    models.Q(("partner__isnull", False), ("user__isnull", True)),
                    _connector="OR",
                ),
                name="user_or_partner_not_both",
            ),
        ),
        migrations.AddConstraint(
            model_name="roleassignment",
            constraint=models.UniqueConstraint(
                condition=models.Q(("user__isnull", False)),
                fields=("user", "role", "business_area", "program"),
                name="unique_user_role_business_area_program",
            ),
        ),
        migrations.AddConstraint(
            model_name="roleassignment",
            constraint=models.UniqueConstraint(
                condition=models.Q(("program__isnull", True), ("user__isnull", False)),
                fields=("user", "role", "business_area"),
                name="unique_user_role_business_area_no_program",
            ),
        ),
        migrations.AddConstraint(
            model_name="roleassignment",
            constraint=models.UniqueConstraint(
                condition=models.Q(("partner__isnull", False)),
                fields=("partner", "role", "business_area", "program"),
                name="unique_partner_role_business_area_program",
            ),
        ),
        migrations.AddConstraint(
            model_name="roleassignment",
            constraint=models.UniqueConstraint(
                condition=models.Q(("partner__isnull", False), ("program__isnull", True)),
                fields=("partner", "role", "business_area"),
                name="unique_partner_role_business_area_no_program",
            ),
        ),
        migrations.AlterUniqueTogether(
            name="adminarealimitedto",
            unique_together={("partner", "program")},
        ),
    ]
