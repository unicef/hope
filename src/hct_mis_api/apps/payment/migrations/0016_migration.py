# Generated by Django 3.2.25 on 2025-01-28 14:17

from django.db import migrations, models
import django.db.models.deletion


def migrate_payments_to_parent_split(apps, schema_editor):
    PaymentPlanSplitPayments = apps.get_model("payment", "PaymentPlanSplitPayments")

    for split_payment in PaymentPlanSplitPayments.objects.all().select_related("payment"):
        split_payment.payment.parent_split_id = split_payment.payment_plan_split_id
        split_payment.payment.save(update_fields=["parent_split"])


def migrate_payments_to_default_split(apps, schema_editor):
    PaymentPlan = apps.get_model("payment", "PaymentPlan")
    PaymentPlanSplit = apps.get_model("payment", "PaymentPlanSplit")

    for payment_plan in PaymentPlan.objects.filter(splits__isnull=True):
        default_split = PaymentPlanSplit.objects.create(payment_plan=payment_plan)
        if payment_plan.delivery_mechanism.sent_to_payment_gateway:
            # store the old object's id in a variable
            old_obj_id = default_split.id
            # it creates a new object
            default_split.id = payment_plan.delivery_mechanism.id # to match data stored in PG
            default_split.sent_to_payment_gateway = True
            default_split.save()
            # and delete the old object
            PaymentPlanSplit.objects.filter(id=old_obj_id).delete()
        payment_plan.payment_items.eligible().update(parent_split=default_split)


class Migration(migrations.Migration):

    dependencies = [
        ('payment', '0015_migration'),
    ]

    operations = [
        migrations.AddField(
            model_name='financialserviceprovider',
            name='required_fields',
            field=django.contrib.postgres.fields.ArrayField(base_field=models.CharField(max_length=255), default=list,
                                                            size=None),
        ),
        migrations.AddField(
            model_name='payment',
            name='has_valid_wallet',
            field=models.BooleanField(default=True),
        ),
        migrations.AlterField(
            model_name='deliverymechanism',
            name='payment_gateway_id',
            field=models.CharField(blank=True, max_length=255, null=True, unique=True),
        ),
        migrations.AlterField(
            model_name='financialserviceprovider',
            name='payment_gateway_id',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.RemoveConstraint(
            model_name='deliverymechanismperpaymentplan',
            name='unique payment_plan_delivery_mechanism',
        ),
        migrations.RemoveField(
            model_name='deliverymechanismperpaymentplan',
            name='chosen_configuration',
        ),
        migrations.RemoveField(
            model_name='deliverymechanismperpaymentplan',
            name='created_by',
        ),
        migrations.RemoveField(
            model_name='deliverymechanismperpaymentplan',
            name='delivery_mechanism_order',
        ),
        migrations.RemoveField(
            model_name='deliverymechanismperpaymentplan',
            name='sent_by',
        ),
        migrations.RemoveField(
            model_name='deliverymechanismperpaymentplan',
            name='sent_date',
        ),
        migrations.RemoveField(
            model_name='deliverymechanismperpaymentplan',
            name='sent_to_payment_gateway',
        ),
        migrations.RemoveField(
            model_name='deliverymechanismperpaymentplan',
            name='status',
        ),
        migrations.AddField(
            model_name='payment',
            name='parent_split',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='split_payment_items', to='payment.paymentplansplit'),
        ),
        migrations.AlterField(
            model_name='deliverymechanismperpaymentplan',
            name='payment_plan',
            field=models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='delivery_mechanism', to='payment.paymentplan'),
        ),
        migrations.AlterField(
            model_name='paymentplansplit',
            name='split_type',
            field=models.CharField(choices=[('NO_SPLIT', 'No Split'), ('BY_RECORDS', 'By Records'), ('BY_COLLECTOR', 'By Collector'), ('BY_ADMIN_AREA1', 'By Admin Area 1'), ('BY_ADMIN_AREA2', 'By Admin Area 2'), ('BY_ADMIN_AREA3', 'By Admin Area 3')], default='NO_SPLIT', max_length=24),
        ),
        migrations.AlterField(
            model_name='paymentplan',
            name='exclude_household_error',
            field=models.TextField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name='paymentplan',
            name='excluded_ids',
            field=models.TextField(blank=True, help_text='Targeting level exclusion', null=True),
        ),
        migrations.AlterField(
            model_name='paymentplan',
            name='exclusion_reason',
            field=models.TextField(blank=True, null=True),
        ),
        migrations.RunPython(migrate_payments_to_parent_split, reverse_code=migrations.RunPython.noop),
        migrations.RunPython(migrate_payments_to_default_split, reverse_code=migrations.RunPython.noop),
        migrations.RemoveField(
            model_name='paymentplansplit',
            name='payments',
        ),
    ]
