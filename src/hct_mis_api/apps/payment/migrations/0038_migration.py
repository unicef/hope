# Generated by Django 3.2.25 on 2025-07-23 08:48

from django.db import migrations, models
import django.db.models.deletion

def pp_assign_reconciliation_file_fk(apps, schema_editor):
    batch_size = 100
    PaymentPlan = apps.get_model("payment", "PaymentPlan")
    FileTemp = apps.get_model("core", "FileTemp")
    pp_to_bulk_upd = []

    payment_plan_qs = PaymentPlan.objects.filter(
        status__in=[PaymentPlan.Status.ACCEPTED, PaymentPlan.Status.FINISHED]).iterator(chunk_size=batch_size)

    for payment_plan in payment_plan_qs:
        file = FileTemp.objects.filter(object_id=str(payment_plan.pk), created_at__gt=payment_plan.status_date).first()
        if file:
            payment_plan.reconciliation_import_file =  file
            pp_to_bulk_upd.append(payment_plan)
    PaymentPlan.objects.bulk_update(pp_to_bulk_upd, ["reconciliation_import_file"])


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0010_migration'),
        ('payment', '0037_migration'),
    ]

    operations = [
        migrations.AddField(
            model_name='paymentplan',
            name='reconciliation_import_file',
            field=models.ForeignKey(blank=True, help_text='Reconciliation Import File', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to='core.filetemp'),
        ),
        migrations.RunPython(pp_assign_reconciliation_file_fk, reverse_code=migrations.RunPython.noop)
    ]
