# Generated by Django 2.2.16 on 2021-09-23 11:27

from django.db import migrations

from hct_mis_api.apps.core.field_attributes.core_fields_attributes import TYPE_DECIMAL
from hct_mis_api.apps.core.utils import fix_flex_type_fields, serialize_flex_attributes


def fix_fields_individuals(apps, schema_editor):
    ImportedIndividual = apps.get_model("registration_datahub", "ImportedIndividual")
    individuals = ImportedIndividual.objects.all()

    all_flex_fields = serialize_flex_attributes().get("individuals", {})
    if all_flex_fields and individuals:
        decimal_flex_fields = [key for key, value in all_flex_fields.items() if value["type"] == TYPE_DECIMAL]

        individuals = fix_flex_type_fields(individuals, decimal_flex_fields)
        ImportedIndividual.objects.bulk_update(individuals, ("flex_fields",), 1000)


def fix_fields_households(apps, schema_editor):
    ImportedHousehold = apps.get_model("registration_datahub", "ImportedHousehold")
    households = ImportedHousehold.objects.all()

    all_flex_fields = serialize_flex_attributes().get("households", {})
    if all_flex_fields and households:
        decimal_flex_fields = [key for key, value in all_flex_fields.items() if value["type"] == TYPE_DECIMAL]

        households = fix_flex_type_fields(households, decimal_flex_fields)
        ImportedHousehold.objects.bulk_update(households, ("flex_fields",), 1000)


class Migration(migrations.Migration):

    dependencies = [
        ('registration_datahub', '0045_migration'),
    ]

    operations = [
        migrations.RunPython(fix_fields_individuals, migrations.RunPython.noop),
        migrations.RunPython(fix_fields_households, migrations.RunPython.noop),
    ]
